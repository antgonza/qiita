{% extends sitebase.html %}

{% block head %}
<script type="text/javascript">
  /**
   * This is a modified version of loadParameterGUI in networkVue.js
   **/
  function loadParameterGUI(p_name, param_info, sel_artifacts_info, target, dflt_val) {
    let vm = this;
    // Create the parameter interface
    var $rowDiv = $('<div>').addClass('row').addClass('form-group').appendTo(target);
    // Replace the '_' by ' ' in the parameter name for readability
    $('<label>').addClass('col-sm-2').addClass('col-form-label').text(p_name.replace('_', ' ') + ': ').appendTo($rowDiv).attr('for', p_name);
    var $colDiv = $('<div>').addClass('col-sm-3').appendTo($rowDiv);

    var p_type = param_info[0];
    var allowed_types = param_info[1];
    var $inp;

    if (p_type == 'artifact' || p_type.startsWith('choice') || p_type.startsWith('mchoice')) {
      // The parameter type is an artifact or choice, the input type is a dropdown
      $inp = $('<select>');
      // show a dropdown menu with the
      var options = [];
      if (p_type.startsWith('choice') || p_type.startsWith('mchoice')) {
        $.each(JSON.parse(p_type.split(':')[1]), function (idx, val) { options.push([val, val]); });

        if (p_type.startsWith('mchoice')) {
          $inp.attr('multiple', true);
        }
      }

      options.sort(function(a, b){return a[0].localeCompare(b[0], 'en', {'sensitivity': 'base'});});
      $.each(options, function(idx, val) {
        $inp.append($("<option>").attr('value', val[0]).text(val[1]));
      });
    }
    else {
      // The rest of parameter types are represented with an input
      $inp = $('<input>');
      // It just changes the type of input
      if (p_name.startsWith("qp-hide")) {
        // adding the hide attributes
        $inp.attr('type', 'hidden');
        $rowDiv.css('display', 'none');
      }
      else if (p_type == 'integer') {
        // For the integer type, show an input of type number
        $inp.attr('type', 'number');
      }
      else if (p_type == 'float') {
        // For the float type, show an input of type number, with a step of 0.001
        $inp.attr('type', 'number').attr('step', 0.001);
      }
      else if (p_type == 'string') {
        // For the float type, show an input of type text
        $inp.attr('type', 'text');
      }
      else if (p_type == 'boolean') {
        // For the boolean type, show an input of type checkbox
        $inp.attr('type', 'checkbox');
      }
      else if (p_type == 'prep_template') {
        $inp.attr('type', 'file');
      }
      else {
        bootstrapAlert("Error: Parameter type (" + p_type + ") not recognized. Please, take a screenshot and <a href='mailto:qiita.help@gmail.com'>contact us</a>", "danger");
      }
    }

    if (dflt_val !== undefined) {
      if (p_type == 'boolean') {
        // The boolean type works differently than the others, so we needed
        // to special case it here.
        if (dflt_val !== 'false' && dflt_val !== false) {
          $inp.prop('checked', true);
        } else {
          $inp.prop('checked', false);
        }
      }
      else {
        $inp.val(dflt_val);
      }
      $inp.addClass('parameter');
    }
    else {
      $inp.addClass('parameter');
    }

    $inp.appendTo($colDiv).attr('id', p_name).attr('name', p_name).addClass('form-control');
  }

  function add_and_submit_job(command_id) {
    // creating a form to send data, this is neccesary so we can send the
    // file; we could do a regular $.post if we didn't need to send a file
    var fd = new FormData(), params = {}, missing = [], files = {};

    $(".parameter").each( function () {
      var value = this.value;
      // file is a special case
      if ( $(this).attr('type') === 'file' ){
        fd.set(this.id, this.files[0]);
      } else {
        if ( $(this).attr('type') === 'checkbox' ) {
          value = this.checked;
        }
        if (value === "") {
          missing.push(this.id)
        }
        params[this.id] = value;
      }
    });

    if (missing.length !== 0){
      alert('You are missing these parameters: ' + missing)
      return false;
    }

    fd.set('command_id', command_id);
    fd.set('params', JSON.stringify(params));

    function _helper_clean_objects(){
        $('#cmd-description').empty();
        $('#parameters').empty();
        $("#cmd_select").val([]);
    }

    // Creating Job
    $('#parameters').empty();
    $('#parameters').html("Creating Job");


    $.ajax({
      url: '/study/process/workflow/',
      type: 'POST',
      processData: false,
      contentType: false,
      data: fd,
      success: function(data) {
        // Submitting Job
        $('#parameters').html("Submitting Job: <b>" + data.job + '</b>');

        $.post("/study/process/workflow/run/", {workflow_id: data.workflow_id}, function(data_submit){
          bootstrapAlert("Workflow " + data.workflow_id + " submitted", "success");
          })
          .fail(function(object, status, error_msg) {
            bootstrapAlert("Error submitting workflow: " + object.statusText, "danger");
          })
          .always(function() {
            _helper_clean_objects();
          });
      },
      error: function (object, status, error_msg) {
        bootstrapAlert(error_msg, "danger");
        _helper_clean_objects();
      }
    });
    return false
  }

  function generate_summary(option_selected){
    var command_id = option_selected.attr('value');
    var command_name = option_selected.text();
    $('#cmd-description').html(option_selected.attr('description'));
    $("#parameters").empty();

    function renderArguments(data, type, row, meta) {
      // select how you want to render the data
      var lines = [], container;

      for (key in data) {
        lines.push('<b>' + key + '</b>:');
        console.log(key, data[key]);
        if (typeof data[key] === 'string'){
          lines.push(data[key]);
        }
        else if (typeof data[key] === 'object') {
          container = data[key];

          // if we have all these attributes then render a named hyperlink to
          //download the data
          if (container['body'] !== undefined &&
              container['filename'] !== undefined &&
              container['content_type'] !== undefined) {
              lines.push('<a download="' + container['filename'] +
                         '" href="data:text/plain;charset=utf-8,' +
                         encodeURIComponent(container['body']) + '">' +
                         container['filename'] + '</a>');
          }
          else {
            lines.push('JavaScript Object')
          }
        }
        else {
          lines.push(data[key]);
        }
      }

      return lines.join('<br>');
    }

    $.get('/study/process/commands/options/', {command_id: command_id})
      .done(function(data){
          $('<div>').appendTo($("#parameters")).attr('id', 'cmd-opts-div').attr('name', 'cmd-opts-div');

          sel_artifacts_info = ''

          $("#cmd-opts-div").append($('<h4>').text('Parameters:'));
          var keys = Object.keys(data.req_options).sort(function(a, b){return a.localeCompare(b, 'en', {'sensitivity': 'base'});});
          for (var i = 0; i < keys.length; i++) {
            var key = keys[i];
            loadParameterGUI(key, data.req_options[key], sel_artifacts_info, $("#cmd-opts-div"));
          }

          var keys = Object.keys(data.opt_options).sort(function(a, b){return a.localeCompare(b, 'en', {'sensitivity': 'base'});});
          for (var i = 0; i < keys.length; i++) {
            var key = keys[i];
            loadParameterGUI(key, data.opt_options[key], sel_artifacts_info, $("#cmd-opts-div"));
          }

          $('<button>').appendTo($("#cmd-opts-div")).addClass('btn btn-info').text('Create Job').click(
            function() {
              this.disabled = true;
              add_and_submit_job(command_id);
              this.disabled = false;
              $('#previous-jobs').hide();
            });

          // load the jobs table for the selected command
          $('#previous-jobs').show();
          $('#previous-jobs-tin').html('Previous "' + command_name + '" jobs');

          // actualizar cada 10 segundos
          $('#private-jobs-table').dataTable({
            "order": [[0, "desc"]],
            "destroy": true,
            "oLanguage": {
              "sZeroRecords": "There are no jobs available",
              "search": "Filter results",
              "loadingRecords": "Please wait - loading previous jobs ...",
            },
            "autoWidth": false,
            "columnDefs": [
              {'width': '13.333%', 'targets': 0, 'data': 6},
              {'width': '13.333%', 'targets': 1, 'data': 7, 'render': renderArguments},
              {'width': '13.333%', 'targets': 2, 'data': 0},
              {'width': '13.333%', 'targets': 3, 'data': 2},
              {'width': '60%', 'targets': 4, 'data': 3},
            ],
            'ajax': "/admin/processing_jobs/list?sEcho=" + Math.floor(Math.random()*10001) + "&commandId=" + command_id,
          });


        });
  }

  function display_artifact_info(artifactId){
    $.get('/artifact/' + artifactId + '/summary/', function(data){
      $("#modal-body").html(data);
    })
      .fail(function(object, status, error_msg) {
        $("#modal-body").html("Error loading artifact information: " + status + " " + object.statusText);
      }
    );
  }


</script>

{% end %}

{%block content %}
  <h3 class="gray-msg">Available Commands</h3>
  <table border="0">
    <tr>
      <td>
        <select id="cmd_select" class="select" size="5" onchange="generate_summary($('option:selected', this));">
        {% for ps in private_software %}
          <optgroup label="{{ps.name}}">
          {% for cmd in ps.commands %}
            <option value="{{cmd.id}}" description="{{cmd.description}}">{{cmd.name}}</option>
          {% end %}
          </optgroup>
        {% end %}
        </select>
      </td>
      <td width="10px"></td>
      <td width="300px">
        <div id="cmd-description"></div>
      </td>
    </tr>
  </table>

  <div id="artifact-info"></div>

  <div id="parameters"></div>

  <div class="modal fade" id="modal-artifact-description" tabindex="-1" role="dialog" aria-labelledby="title" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="title">Artifact Summary</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div id="previous-jobs" style="display: none;" class="col-sm-12">
      <h3 id="previous-jobs-tin" class="gray-msg">Previous Jobs</h3>
      <table id="private-jobs-table" class="table table-bordered gray-msg" style="width: 30px!">
        <thead>
          <tr>
            <th class="sorting sorting_asc" tabindex="0" aria-controls="private-jobs-table" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Last Updated">Last Updated</th>
            <th class="sorting sorting_asc" tabindex="0" aria-controls="private-jobs-table" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Last Updated">Arguments</th>
            <th class="sorting sorting_asc" tabindex="0" aria-controls="private-jobs-table" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Job ID">Job ID</th>
            <th class="sorting sorting_asc" tabindex="0" aria-controls="private-jobs-table" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Status">Status</th>
            <th class="sorting sorting_asc" tabindex="0" aria-controls="private-jobs-table" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Message">Message</th>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>


{% end %}
